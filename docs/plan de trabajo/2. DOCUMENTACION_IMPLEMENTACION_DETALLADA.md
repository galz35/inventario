# Documento de Implementación — Sistema de Inventario y Órdenes de Trabajo

## SECCIÓN -1 — DEMO MVP Y ALCANCE POR FASES (OBLIGATORIO)

**MVP Validable (Objetivo Inmediato):**
1.  **Flujo OT Completo:** Crear OT → Asignar a Técnico → Iniciar → Registrar Consumo (Materiales) → Subir Evidencia (Foto) → Firma Cliente → Cierre.
2.  **Inventario Exacto:** El stock solo y exclusivamente se mueve mediante transacciones trazables en el Kardex. Prohibido "editar celda".
3.  **Almacén Móvil:** Cada vehículo/técnico es un almacén lógico real. El consumo sale de SU almacén, no del central.
4.  **Transferencias:** Envio desde Central → Recepción en Móvil (requiere confirmación para impactar stock destino).

**No en Producción (Diseñado pero fuera de MVP):**
*   Conteo físico con snapshot y aprobación (Fase 2).
*   Liquidación automática de consignación (Fase 2).
*   Ciclo de vida complejo de activos fijos (reparación externa, baja contable) (Fase 3).
*   Reportes gerenciales de BI (Fase 3).

---

## SECCIÓN 0 — RESUMEN

**Objetivo:** Sistema de gestión operativa para empresas de telecomunicaciones (HFC) que centraliza el control de inventarios, activos y órdenes de trabajo en campo, garantizando trazabilidad financiera y operativa.

**Usuarios y Roles:**
*   **Administrador:** Control total, configuración, ajustes de inventario.
*   **Bodega:** Recepción, despacho, transferencias.
*   **Supervisor:** Asignación de OTs, revisión de cierres, control de técnicos.
*   **Técnico:** Ejecución de OTs, gestión de su stock móvil, custodia de herramientas.
*   **Gerencia:** Visualización de KPIs y reportes.

**Módulos:** Inventario Consumible, Consignaciones, Activos Fijos, Órdenes de Trabajo, Proyectos, Reportes.

**Fuera de Alcance:** Facturación, Punto de Venta (POS), Contabilidad General, Recursos Humanos.

---

## SECCIÓN 1 — GLOSARIO

*   **Almacén Padre / Sub-almacén:** Jerarquía logística. Ej: "Bodega Central" (Padre) -> "Norte" (Sub) -> "Camioneta Técnico Juan" (Sub).
*   **Kardex:** Historial inmutable de movimientos de un producto en un almacén. (Fecha, Tipo, Cantidad, Saldo resultante).
*   **Movimiento:** Cualquier alteración del stock (Entrada, Salida, Transferencia, Ajuste).
*   **Consignación:** Material en bodega física de la empresa pero propiedad legal del Proveedor. Se paga ("Liquida") solo cuando se consume.
*   **OT (Orden de Trabajo):** Instrucción de servicio para un cliente (Instalación, Reparación). Consume materiales.
*   **Consumo:** Acción de gastar material en una OT. Resta del inventario del técnico.
*   **Confirmación de Transferencia:** Acción de aceptar mercadería enviada de otro almacén. Hasta no confirmar, el stock está "En Tránsito".

---

## SECCIÓN 2 — ROLES, PERMISOS Y LOGIN

**2.1 Matriz de Acceso Simplificada:**

| Módulo | Admin | Bodega | Supervisor | Técnico |
| :--- | :---: | :---: | :---: | :---: |
| **Config/Usuarios** | Total | - | - | - |
| **Inventario Global** | Total | Total | Ver | - |
| **Inventario Propio** | - | - | - | Ver/Gestionar |
| **Transferencias** | Total | Total | Ver | Confirmar Recibo |
| **OTs** | Total | - | Asignar/Ver | Ejecutar/Cerrar |
| **Ajustes Stock** | Total | Solicitar | Aprobar | - |
| **Reportes** | Total | Operativos | Operativos | - |

**2.2 Seguridad Técnica:**
*   **Auth:** JWT (Token de acceso 30min, Refresh Token rotativo 7 días).
*   **Password:** Hashing con `bcrypt`.
*   **Auditoría:** Tablas `Inv_seg_auditoria_eventos` registran Quién, Cuándo, Qué (JSON con valores previos/nuevos).

---

## SECCIÓN 3 — MÓDULOS DE NEGOCIO

### 3.1 Catálogos
Gestiona Productos (Consumibles vs Serializados), Proveedores, Clientes y Tipos de OT.
*   *Regla:* Categorización estricta. Un producto "Serializado" (Módem) no se gestiona igual que un "Consumible" (Conector, Cable).

### 3.2 Almacenes
Estructura jerárquica.
*   **Regla:** Todo Técnico tiene asignado un Almacén tipo `MOVIL`. Al despedir al técnico, el almacén se inventaria y cierra.

### 3.3 Inventario Consumible (El Corazón)
*   **Principio:** El stock es el resultado de la suma de movimientos.
*   **Tipos de Movimiento:** `ENTRADA_COMPRA`, `ENTRADA_CONSIGNACION`, `TRANSFERENCIA_ENVIO`, `TRANSFERENCIA_RECEPCION`, `CONSUMO_OT`, `AJUSTE_INVENTARIO`.
*   **Regla:** `Saldo Actual = Saldo Anterior + Cantidad Movimiento`. Validado por SP transaccional.

### 3.4 Transferencias
Proceso de dos pasos para garantizar responsabilidad:
1.  **Envío:** Bodega Central descuenta stock y lo marca "En Tránsito".
2.  **Recepción:** Técnico cuenta física y confirma en App. Stock entra a su almacén móvil.

### 3.5 Consignación
Gestión de stock ajeno.
*   El stock se guarda con `propietarioId`.
*   Al consumir en una OT, el sistema marca ese ítem para la "Liquidación Mensual" al proveedor.

### 3.6 Órdenes de Trabajo (OT)
Ciclo de vida:
1.  **Registrada:** Viene del CRM o se crea manual.
2.  **Asignada:** Supervisor la pone en la cola de un Técnico.
3.  **En Proceso:** Técnico hace "Check-in" en sitio.
4.  **Cierre:** Técnico reporta materiales usados, escanea equipos instalados, toma foto de instalación y recoge firma cliente.
5.  **Finalizada:** Supervisor valida y cierra contablemente.

### 3.7 Proyectos
Agrupador financiero.
*   Permite ver costos acumulados de múltiples OTs asociadas a un despliegue mayor (ej: "Fibra Barrio Norte").

### 3.8 Activos Serializados
Control unitario por Código de Barras / QR / Serie.
*   Estados: `EN_ALMACEN`, `ASIGNADO_TECNICO`, `INSTALADO_CLIENTE`, `EN_REPARACION`, `BAJA`.
*   Trazabilidad completa: Qué técnico tuvo qué módem en qué fecha.

### 3.9 Conteo Físico
Proceso de auditoría.
1.  **Snapshot:** Se congela el stock esperado del sistema.
2.  **Conteo Ciego:** Operarios ingresan cantidades reales.
3.  **Análisis:** Sistema muestra diferencias.
4.  **Ajuste:** Admin aprueba ajustes para igualar sistema a realidad.

---

## SECCIÓN 4 — UI/UX

**Filosofía:** "Información densa pero limpia". Evitar espacios blancos innecesarios.
**Paleta:** Escala de Grises + Acentos Semánticos (Rojo=Error/Pendiente, Verde=Éxito/Saldo, Naranja=Alerta). **NO AZUL GENÉRICO.**

**Layouts Clave:**
*   **Desktop:** Sidebar colapsable, Tablas de datos densas con filtros en cabecera, Modales para acciones rápidas.
*   **Móvil (Técnico):** Botones grandes ("Thumb-friendly"), flujos lineales (Paso 1 -> Paso 2), Modo Offline (si aplica).

---

## SECCIÓN 5 — MODELO DE DATOS SQL SERVER

**Prefijo Global:** `Inv_`

### Tablas Principales

**Seguridad:**
*   `Inv_seg_usuarios` (id, email, password_hash, rol)
*   `Inv_seg_permisos`

**Catálogos:**
*   `Inv_cat_productos` (id, codigo, nombre, es_serializado, unidad)
*   `Inv_cat_almacenes` (id, nombre, tipo_responsable, usuario_responsable_id)

**Inventario:**
*   `Inv_inv_stock` (almacen_id, producto_id, cantidad, propietario_id) -> **PK Compuesta**
*   `Inv_inv_movimientos` (id, fecha, tipo, usuario_id, referencia) -> **Header**
*   `Inv_inv_movimientos_detalle` (movimiento_id, producto_id, cantidad, saldo_anterior, n_costo)

**Operaciones:**
*   `Inv_ope_ot` (id, cliente, estado, tecnico_asignado_id, fechas...)
*   `Inv_ope_ot_consumos` (ot_id, producto_id, cantidad)
*   `Inv_ope_ot_evidencias` (ot_id, url_foto, tipo)

**Activos:**
*   `Inv_act_activos` (serie, producto_id, estado, ubicacion_actual_id)

---

## SECCIÓN 6 — STORED PROCEDURES BASE

El sistema sigue el patrón **SP-First** para lógica crítica.

1.  `Inv_sp_inv_movimiento_registrar`: Valida stock, inserta header y detalles, actualiza tabla de stock, todo en TRANSACTION.
2.  `Inv_sp_ot_crear_asignar`: Crea OT y opcionalmente asigna técnico y notifica.
3.  `Inv_sp_ot_consumir_material`: Wrapper que llama al SP de movimiento tipo 'CONSUMO' y lo asocia a la OT.
4.  `Inv_sp_inv_transferencia_confirmar`: Mueve stock de "Tránsito" a "Destino".
5.  `Inv_sp_kardex_reporte`: Genera la sábana de movimientos con saldos calculados.

---

## SECCIÓN 8 — CHECKLIST DE IMPLEMENTACIÓN (PLAN 0-100)

**Fase 1: Fundamentos (Hecho)**
- [x] Base de Datos y Tablas Core.
- [x] Autenticación JWT y Roles.
- [x] Catálogos Básicos (Productos, Usuarios).

**Fase 2: Inventario Core (Hecho/Ajuste)**
- [x] Movimientos de Stock básicos.
- [x] Visualización de Stock por Almacén.
- [ ] Transferencias con Confirmación (Validar flujo completo).

**Fase 3: Operaciones (En Proceso)**
- [x] CRUD OTs.
- [x] Asignación a Técnicos.
- [ ] Registro Consumo Materiales en OT (Validar descuento stock técnico).
- [ ] Cierre OT con Evidencia.

**Fase 4: Activos y Flota (Próximo)**
- [ ] Módulo Activos Serializados.
- [ ] Módulo Vehículos Básico (Log).

**Fase 5: Estabilización**
- [ ] Pruebas de Estrés.
- [ ] Hardening de Seguridad.
- [ ] Documentación Final.

---
*Este documento es la fuente de verdad única para el desarrollo del sistema INVCORE.*
